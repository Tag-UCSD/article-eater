name: Governance
on: { pull_request: {}, push: { branches: [ main, master ] } }
jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Governance checks
        run: |
          if [ -f scripts/check_governance.py ]; then python scripts/check_governance.py; fi
          if [ -f scripts/orphan_sweep.py ]; then python scripts/orphan_sweep.py --fail-on-new; fi
          if [ -f scripts/public_surface_ledger.py ]; then python scripts/public_surface_ledger.py --verify; fi
          if [ -f scripts/manifest_sha256.py ]; then python scripts/manifest_sha256.py --verify; fi
      - name: Conversation guard
        run: |
          BODY_FILE=$(mktemp)
          echo "${{ github.event.pull_request.body }}" > "$BODY_FILE"
          if [ -f scripts/conversation_guard.py ]; then python scripts/conversation_guard.py --pr-body-file "$BODY_FILE"; fi
      - name: Secret scan
        uses: zricethezav/gitleaks-action@v2
      - name: Tests
        run: |
          if [ -d tests ]; then pytest -q; fi